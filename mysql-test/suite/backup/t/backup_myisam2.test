# Tests specific of MyISAM's online backup.

--source include/not_embedded.inc
--source include/have_debug_sync.inc

#
# Cleanup from former test cases
#
--disable_warnings
SET DEBUG_SYNC= 'RESET';
DROP DATABASE IF EXISTS mysqltest;
let $MYSQLD_DATADIR= `SELECT @@datadir`;
--error 0,1
remove_file $MYSQLD_DATADIR/test.ba;
--enable_warnings

#
# Create database.
#
CREATE DATABASE mysqltest;
USE mysqltest;

#
# Create table with long records (causing records' length to be stored
# in a long format in the backup log).
#
CREATE TABLE t1 (c1 LONGTEXT) ENGINE=MyISAM;

    #
    # Create a worker connection, using mysqltest as its default database.
    #
    --echo
    --echo connection backup: Start backup
    connect (backup,localhost,root,,mysqltest);

    # Activate the sync point for BACKUP. Before starting the prepare phase,
    # BACKUP reaches the sync point "before_backup_data_prepare", which will
    # emit the signal "bup_sync" and then wait for the signal "bup_finish"
    # to be emitted by another connection.
    SET DEBUG_SYNC= 'before_backup_data_prepare SIGNAL bup_sync
                     WAIT_FOR bup_finish';
    send BACKUP DATABASE mysqltest TO 'test.ba';

--echo
--echo connection default: Wait for BACKUP to reach its sync point
connection default;
SET DEBUG_SYNC= 'now WAIT_FOR bup_sync';

--echo Insert data
INSERT INTO t1 VALUES ("text");
let $1=16;
while ($1)
{
  UPDATE t1 SET c1=concat(c1,c1);
  dec $1;
}
SELECT LENGTH(c1) FROM t1;
CHECKSUM TABLE t1;

--echo Signal BACKUP to finish
SET DEBUG_SYNC= 'now SIGNAL bup_finish';

    --echo
    --echo connection backup: Fetch result
    connection backup;
    --replace_column 1 #
    reap;
    REPAIR TABLE t1 QUICK;
    DROP DATABASE mysqltest;

    --replace_column 1 #
    RESTORE FROM 'test.ba';

    SELECT LENGTH(c1) FROM t1;
    CHECKSUM TABLE t1;

    disconnect backup;

--echo
--echo connection default: cleanup
connection default;
remove_file $MYSQLD_DATADIR/test.ba;
SET DEBUG_SYNC= 'RESET';


--echo
--echo #
--echo # Bug#38045 - Backup, MyISAM and file system encoding
--echo #
CREATE TABLE `äöüß£å` (id SERIAL) ENGINE=MyISAM;
--replace_column 1 #
BACKUP DATABASE mysqltest TO 'test.ba';
DROP TABLE `äöüß£å`;
remove_file $MYSQLD_DATADIR/test.ba;


#
# Cleanup from this test case
#
--echo
--echo # final cleanup
USE test;
DROP DATABASE mysqltest;
SET DEBUG_SYNC= 'RESET';

